name: CI
on:
  schedule:
  - cron: '0 3 * * *'
jobs:
  bases:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        image:
        - alpine
        - blackarch
        - c-builder
        - debian
        - distroless
        - go-builder
        - openjdk
        - python
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Build & Push
      run: ./build.py ${{ matrix.image }}
      env:
        REGISTRY_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  apps:
    runs-on: ubuntu-20.04
    needs:
    - bases
    strategy:
      matrix:
        image:
        # cxx
        - aria2
        - chrony
        - dnsmasq
        - haveged
        - hostapd
        - nginx
        - unbound
        # go
        - cadvisor
        - grafana
        - lego
        - prometheus
        - prometheus-alertmanager
        - prometheus-blackbox-exporter
        - prometheus-node-exporter
        - prometheus-signal-receiver
        - syncthing
        - stdiscosrv
        - strelaysrv
        # python
        - prometheus-nftables-exporter
        - prometheus-smart-collector
        # misc
        - prometheus-apt-collector
        - webui-aria2
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Build & Push
      run: ./build.py ${{ matrix.image }}
      env:
        REGISTRY_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

