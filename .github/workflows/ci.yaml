name: CI
on:
  push:
    branches:
    - master
    paths-ignore:
    - '**.md'
  schedule:
  - cron: '0 3 * * *'
jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Submodule Status
      run: echo ::set-env name=SUBMODULE_KEY::$(git submodule status | grep -Eo [a-f0-9]{40} | sha256sum | cut -d ' ' -f 1)
    - name: Cache Submodules
      uses: actions/cache@v2
      with:
        path: |
          .git/modules
          */src
        key: submodule-${{ env.SUBMODULE_KEY }}
    - name: Build & Push
      run: ./build.py
      env:
        REGISTRY_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        COMMIT_BEFORE: ${{ github.event.before }}
        COMMIT_NOW: ${{ github.sha }}

